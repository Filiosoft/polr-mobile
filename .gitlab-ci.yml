image: filiosoft/android-node:latest
variables:
  S3_BUCKET_NAME: "polr-mobile.filiosoft.net"
  VERSION_NUMBER: "0.1.0"
cache:
  paths:
  - node_modules/

dev-build-android:
  stage: build
  tags: 
    - docker
  before_script:
    - npm i -qq
    - npm i -qq scv-cli
  script:
    - node node_modules/scv-cli/scv.js -n $VERSION_NUMBER -b $CI_PIPELINE_ID
    - node node_modules/gulp/bin/gulp.js
  after_script:
    - mv bin/Android/Release/android-release.apk Polr-Mobile-Dev-$VERSION_NUMBER-$CI_PIPELINE_ID.apk
  artifacts:
    paths:
    - Polr-Mobile-Dev-$VERSION_NUMBER-$CI_PIPELINE_ID.apk
  except:
    - tags

release-build-android:
  stage: build
  tags: 
    - docker
  before_script:
    - npm i -qq
    - npm i -qq scv-cli
  script:
    - node node_modules/scv-cli/scv.js -n $CI_BUILD_TAG -b $CI_PIPELINE_ID
    - node node_modules/gulp/bin/gulp.js
  after_script:
    - mv bin/Android/Release/android-release.apk Polr-Mobile-Release-$CI_BUILD_TAG-$CI_PIPELINE_ID.apk
  artifacts:
    paths:
    - Polr-Mobile-Release-$CI_BUILD_TAG-$CI_PIPELINE_ID.apk
  only:
    - tags

lint:
  stage: test
  tags: 
    - docker
  before_script:
    - npm i -qq
  script:
    - node node_modules/gulp/bin/gulp.js test

deploy:
  image: filiosoft/aws-cli:latest
  stage: deploy
  tags: 
    - docker
  script:
  - aws s3 cp ./ s3://$S3_BUCKET_NAME/ --recursive --exclude ".gitlab-ci.yml" --include "*"
  only:
  - gh-pages

pages:
  stage: deploy
  image: alpine:latest
  environment: pages
  tags:
    - docker
  script:
  - mkdir .public
  - cp -r * .public
  - mv .public public
  artifacts:
    paths:
    - public
  only:
  - gh-pages
 
mirror: 
  stage: deploy
  tags: 
    - docker
  script:
   - git clone --bare https://nprail:$GITLAB_ACCESS_KEY@gitlab.filiosoft.com/oss/polr-mobile.git
   - cd polr-mobile.git
   - git push --mirror https://nprail:$GITHUB_ACCESS_KEY@github.com/Filiosoft/polr-mobile.git